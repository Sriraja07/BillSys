{% extends "base.html" %}

{% block title %}Add Purchase - Electrical Billing Software{% endblock %}
{% block page_title %}Add Purchase{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
    <!-- Product Selection Panel -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Search and Filters -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Select Products</h3>
            <div class="space-y-3">
                <input type="text" id="productSearch" placeholder="Search products..." 
                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select id="categoryFilter" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Categories</option>
                    {% for category in products|map(attribute='category')|unique %}
                        <option value="{{ category }}">{{ category }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Product Grid -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Products</h3>
            <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-96 overflow-y-auto">
                {% for product in products %}
                <div class="product-card border border-gray-200 rounded-lg p-3 hover:border-blue-300 transition-colors cursor-pointer" 
                     data-product-id="{{ product.id }}" 
                     data-name="{{ product.name }}" 
                     data-price="{{ product.cost_price }}" 
                     data-gst="{{ product.gst_rate }}" 
                     data-stock="{{ product.stock_quantity }}"
                     data-category="{{ product.category }}">
                    <div class="flex justify-between items-start mb-1">
                        <h4 class="font-medium text-gray-900 text-xs">{{ product.name[:20] }}{% if product.name|length > 20 %}...{% endif %}</h4>
                        <span class="text-xs font-semibold text-blue-600">â‚¹{{ product.cost_price }}</span>
                    </div>
                    <div class="flex justify-between items-end">
                        <div>
                            <p class="text-xs text-gray-500">{{ product.category }}</p>
                            <p class="text-xs text-gray-500">GST: {{ product.gst_rate }}%</p>
                        </div>
                        <div class="text-right">
                            <p class="font-medium text-xs {% if product.stock_quantity <= 5 %}text-red-600{% elif product.stock_quantity <= 20 %}text-yellow-600{% else %}text-green-600{% endif %}">
                                Stock: {{ product.stock_quantity }}
                            </p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination Controls -->
            <div id="paginationControls" class="mt-4 flex justify-center space-x-2">
                <button id="prevPage" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 disabled:opacity-50">Previous</button>
                <span id="pageInfo" class="px-3 py-1 text-sm text-gray-700"></span>
                <button id="nextPage" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 disabled:opacity-50">Next</button>
            </div>
        </div>
    </div>

    <!-- Purchase Panel -->
    <div class="lg:col-span-3 space-y-6">
        <!-- Vendor Selection -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Vendor Details</h3>
            <input id="testBill" class="hidden" value="{{bill_no}}">
            <div class="space-y-3">
                <div class="relative">
                    <input 
                        type="text" 
                        id="vendorSearch" 
                        placeholder="Search vendor by mobile number or name..."
                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        autocomplete="off"
                    >
                    <div id="vendorDropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto hidden">
                        <div class="p-2 hover:bg-gray-100 cursor-pointer border-b" data-vendor-id="" data-vendor-name="Walk-in vendor" data-vendor-mobile="">
                            <div class="font-medium">Walk-in vendor</div>
                            <div class="text-sm text-gray-500">No vendor details</div>
                        </div>
                        {% for vendor in vendors %}
                        <div class="p-2 hover:bg-gray-100 cursor-pointer border-b vendor-option" 
                             data-vendor-id="{{ vendor.id }}" 
                             data-vendor-name="{{ vendor.name }}" 
                             data-vendor-mobile="{{ vendor.mobile_number }}"
                             data-search-text="{{ vendor.name.lower() }} {{ vendor.mobile_number }}">
                            <div class="font-medium">{{ vendor.name }}</div>
                            <div class="text-sm text-gray-500">{{ vendor.mobile_number }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div id="selectedVendor" class="hidden bg-blue-50 border border-blue-200 rounded-md p-3">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-medium text-blue-900" id="selectedVendorName"></div>
                            <div class="text-sm text-blue-700" id="selectedVendorMobile"></div>
                        </div>
                        <button onclick="clearVendorSelection()" class="text-blue-600 hover:text-blue-800">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                                <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                              </svg>
                              
                        </button>
                    </div>
                </div>
                <input type="hidden" id="VendorSelect" value="">
                <button id="addVendorBtn" class="w-full bg-blue-100 hover:bg-blue-200 text-blue-700 py-2 rounded-md transition-colors text-sm flex justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -1 24 24" fill="currentColor" class="size-5 mr-1">
                        <path fill-rule="evenodd" d="M12 3.75a.75.75 0 0 1 .75.75v6.75h6.75a.75.75 0 0 1 0 1.5h-6.75v6.75a.75.75 0 0 1-1.5 0v-6.75H4.5a.75.75 0 0 1 0-1.5h6.75V4.5a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" />
                      </svg>
                      Quick Add Vendor
                </button>
            </div>
            <div class="p-1 mt-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">PO Bill Number</label>
                <input type="text" id="poBillNo" placeholder="Enter PO Bill Number" 
                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="p-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">Purchase Date</label>
                <input type="date" id="purchaseDate" 
                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       required>
            </div>
        </div>

        <!-- Purchase Items -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Purchase Items</h3>
                <button id="clearCart" class="text-red-600 hover:text-red-800 text-sm flex cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-5 mr-1">
                        <path fill-rule="evenodd" d="M16.5 4.478v.227a48.816 48.816 0 0 1 3.878.512.75.75 0 1 1-.256 1.478l-.209-.035-1.005 13.07a3 3 0 0 1-2.991 2.77H8.084a3 3 0 0 1-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 0 1-.256-1.478A48.567 48.567 0 0 1 7.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 0 1 3.369 0c1.603.051 2.815 1.387 2.815 2.951Zm-6.136-1.452a51.196 51.196 0 0 1 3.273 0C14.39 3.05 15 3.684 15 4.478v.113a49.488 49.488 0 0 0-6 0v-.113c0-.794.609-1.428 1.364-1.452Zm-.355 5.945a.75.75 0 1 0-1.5.058l.347 9a.75.75 0 1 0 1.499-.058l-.346-9Zm5.48.058a.75.75 0 1 0-1.498-.058l-.347 9a.75.75 0 0 0 1.5.058l.345-9Z" clip-rule="evenodd" />
                    </svg>
                    Clear All
                </button>
            </div>
            <div id="cartItems" class="space-y-2 max-h-48 overflow-y-auto">
                <p class="text-gray-500 text-center py-8">No items added yet</p>
            </div>
        </div>

        <!-- Totals -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Purchase Summary</h3>
            <div class="space-y-3">
                <div class="flex justify-between text-sm">
                    <span>Subtotal:</span>
                    <span id="subtotal">â‚¹0.00</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span>Discount:</span>
                    <div class="flex items-center space-x-2">
                        <span>â‚¹</span>
                        <input type="number" id="discountAmount" min="0" step="0.01" placeholder="0.00" 
                            class="w-20 border border-gray-300 rounded px-2 py-1 text-xs text-right">
                    </div>
                </div>
                <div class="flex justify-between text-sm items-center">
                    <div class="flex items-center space-x-2">
                        <span>CGST:</span>
                        <input type="number" id="cgstRate" min="0" max="50" step="0.25"
                               class="w-16 border border-gray-300 rounded px-2 py-1 text-xs text-right" 
                               onchange="calculateTotals()" value="9">
                        <span>%</span>
                    </div>
                    <span id="cgstAmount" class="text-sm">â‚¹0.00</span>
                </div>
                <div class="flex justify-between text-sm items-center">
                    <div class="flex items-center space-x-2">
                        <span>SGST:</span>
                        <input type="number" id="sgstRate" min="0" max="50" step="0.25" 
                               class="w-16 border border-gray-300 rounded px-2 py-1 text-xs text-right" 
                               onchange="calculateTotals()" value="9">
                        <span>%</span>
                    </div>
                    <span id="sgstAmount" class="text-sm">â‚¹0.00</span>
                </div>
                <div class="flex justify-between font-bold text-lg border-t pt-2">
                    <span>Total:</span>
                    <span id="finalTotal">â‚¹0.00</span>
                </div>
            </div>
        </div>

        <!-- Payment Section -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Payment Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                    <select id="paymentMethod" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="cash">Cash</option>
                        <option value="card">Card</option>
                        <option value="upi">UPI</option>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="cheque">Cheque</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Amount</label>
                    <input type="number" id="paymentAmount" min="0" step="0.01" placeholder="0.00" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="mt-6 space-y-3">
            <button id="createPurchase" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-md transition-colors font-medium flex justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-5 mr-1">
                    <path fill-rule="evenodd" d="M3.75 3.375c0-1.036.84-1.875 1.875-1.875H9a3.75 3.75 0 0 1 3.75 3.75v1.875c0 1.036.84 1.875 1.875 1.875H16.5a3.75 3.75 0 0 1 3.75 3.75v7.875c0 1.035-.84 1.875-1.875 1.875H5.625a1.875 1.875 0 0 1-1.875-1.875V3.375Zm10.5 1.875a5.23 5.23 0 0 0-1.279-3.434 9.768 9.768 0 0 1 6.963 6.963A5.23 5.23 0 0 0 16.5 7.5h-1.875a.375.375 0 0 1-.375-.375V5.25Z" clip-rule="evenodd" />
                </svg>
                Create Purchase
            </button>
        </div>
    </div>
</div>

<!-- Quick Add Vendor Modal -->
<div id="vendorModal" class="fixed inset-0 bg-gray-600/75 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Quick Add Customer</h3>
                <form id="quickVendorForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                        <input type="text" id="vendorName" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mobile Number *</label>
                        <input type="tel" id="vendorMobile" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-6 py-3 flex justify-end space-x-3">
                <button onclick="closeVendorModal()" class="bg-white text-gray-700 border border-gray-300 rounded-md px-4 py-2 hover:bg-gray-50">
                    Cancel
                </button>
                <button onclick="saveVendor()" class="bg-blue-600 text-white rounded-md px-4 py-2 hover:bg-blue-700">
                    Add Vendor
                </button>
            </div>
        </div>
    </div>
</div>


<script>
let cart = [];
let allProducts = [];
// Load products from template
try {
    allProducts = JSON.parse('{{ products_json|tojson|safe }}');
} catch(e) {
    console.error('Error loading products:', e);
}
let currentPage = 1;
const productsPerPage = 20;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('purchaseDate').value = today;
    
    displayProducts();
    updatePaginationControls();
});

// Product search and filter
document.getElementById('productSearch').addEventListener('input', filterProducts);
document.getElementById('categoryFilter').addEventListener('change', filterProducts);

function filterProducts() {
    currentPage = 1;
    displayProducts();
    updatePaginationControls();
}

function getFilteredProducts() {
    const search = document.getElementById('productSearch').value.toLowerCase();
    const category = document.getElementById('categoryFilter').value;
    
    return allProducts.filter(product => {
        const matchesSearch = product.name.toLowerCase().includes(search);
        const matchesCategory = !category || product.category === category;
        return matchesSearch && matchesCategory;
    });
}

function displayProducts() {
    const filteredProducts = getFilteredProducts();
    const startIndex = (currentPage - 1) * productsPerPage;
    const endIndex = startIndex + productsPerPage;
    const productsToShow = filteredProducts.slice(startIndex, endIndex);
    
    const productsGrid = document.getElementById('productsGrid');
    productsGrid.innerHTML = '';
    
    productsToShow.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card border border-gray-200 rounded-lg p-3 hover:border-blue-300 transition-colors cursor-pointer';
        productCard.dataset.productId = product.id;
        productCard.dataset.name = product.name;
        productCard.dataset.price = product.cost_price;
        productCard.dataset.gst = product.gst_rate;
        productCard.dataset.stock = product.stock_quantity;
        productCard.dataset.category = product.category;
        
        productCard.innerHTML = `
            <div class="flex justify-between items-start mb-1">
                <h4 class="font-medium text-gray-900 text-xs">${product.name.length > 20 ? product.name.substring(0, 20) + '...' : product.name}</h4>
                <span class="text-xs font-semibold text-blue-600">â‚¹${product.cost_price}</span>
            </div>
            <div class="flex justify-between items-end">
                <div>
                    <p class="text-xs text-gray-500">${product.category}</p>
                    <p class="text-xs text-gray-500">GST: ${product.gst_rate}%</p>
                </div>
                <div class="text-right">
                    <p class="font-medium text-xs ${product.stock_quantity <= 5 ? 'text-red-600' : product.stock_quantity <= 20 ? 'text-yellow-600' : 'text-green-600'}">
                        Stock: ${product.stock_quantity}
                    </p>
                </div>
            </div>
        `;
        
        productCard.addEventListener('click', () => addToCart(productCard));
        productsGrid.appendChild(productCard);
    });
}

function updatePaginationControls() {
    const filteredProducts = getFilteredProducts();
    const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
    
    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
    document.getElementById('prevPage').disabled = currentPage === 1;
    document.getElementById('nextPage').disabled = currentPage === totalPages;
}

// Pagination controls
document.getElementById('prevPage').addEventListener('click', () => {
    if (currentPage > 1) {
        currentPage--;
        displayProducts();
        updatePaginationControls();
    }
});

document.getElementById('nextPage').addEventListener('click', () => {
    const filteredProducts = getFilteredProducts();
    const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        displayProducts();
        updatePaginationControls();
    }
});

// Cart functionality
function addToCart(productCard) {
    const productId = productCard.dataset.productId;
    const name = productCard.dataset.name;
    const price = parseFloat(productCard.dataset.price);
    const gst = parseFloat(productCard.dataset.gst);
    const stock = parseInt(productCard.dataset.stock);

    const existingItem = cart.find(item => item.productId === productId);
    
    if (existingItem) {
        existingItem.quantity++;
    } else {
        cart.push({
            productId: productId,
            name: name,
            price: price,
            gst: gst,
            quantity: 1,
            stock: stock
        });
    }
    
    updateCartDisplay();
    calculateTotals();
}

function updateCartDisplay() {
    const cartItems = document.getElementById('cartItems');
    
    if (cart.length === 0) {
        cartItems.innerHTML = '<p class="text-gray-500 text-center py-8">No items added yet</p>';
        return;
    }
    
    cartItems.innerHTML = cart.map(item => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-md">
            <div class="flex-1">
                <p class="font-medium text-sm">${item.name}</p>
                <p class="text-xs text-gray-500">â‚¹${item.price.toFixed(2)} each</p>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="updateQuantity('${item.productId}', ${item.quantity - 1})" 
                        class="w-6 h-6 bg-red-500 text-white rounded-full text-xs hover:bg-red-600">-</button>
                <span class="w-8 text-center text-sm">${item.quantity}</span>
                <button onclick="updateQuantity('${item.productId}', ${item.quantity + 1})" 
                        class="w-6 h-6 bg-green-500 text-white rounded-full text-xs hover:bg-green-600">+</button>
                <button onclick="removeFromCart('${item.productId}')" 
                        class="ml-2 text-red-600 hover:text-red-800 text-xs">Remove</button>
            </div>
        </div>
    `).join('');
}

function updateQuantity(productId, newQuantity) {
    if (newQuantity <= 0) {
        removeFromCart(productId);
        return;
    }
    
    const item = cart.find(item => item.productId === productId);
    if (item) {
        item.quantity = newQuantity;
        updateCartDisplay();
        calculateTotals();
    }
}

function removeFromCart(productId) {
    cart = cart.filter(item => item.productId !== productId);
    updateCartDisplay();
    calculateTotals();
}

function calculateTotals() {
    const discount = parseFloat(document.getElementById('discountAmount').value) || 0;
    const cgstRate = parseFloat(document.getElementById('cgstRate').value) || 0;
    const sgstRate = parseFloat(document.getElementById('sgstRate').value) || 0;
    
    let subtotal = 0;
    cart.forEach(item => {
        subtotal += item.price * item.quantity;
    });
    
    const discountedSubtotal = subtotal - discount;
    const totalCGST = (discountedSubtotal * cgstRate) / 100;
    const totalSGST = (discountedSubtotal * sgstRate) / 100;
    const finalTotal = discountedSubtotal + totalCGST + totalSGST;
    
    document.getElementById('subtotal').textContent = 'â‚¹' + subtotal.toFixed(2);
    document.getElementById('cgstAmount').textContent = 'â‚¹' + totalCGST.toFixed(2);
    document.getElementById('sgstAmount').textContent = 'â‚¹' + totalSGST.toFixed(2);
    document.getElementById('finalTotal').textContent = 'â‚¹' + finalTotal.toFixed(2);

}

// Event listeners
document.getElementById('discountAmount').addEventListener('input', calculateTotals);
document.getElementById('clearCart').addEventListener('click', () => {
    cart = [];
    updateCartDisplay();
    calculateTotals();
});

// Create purchase
document.getElementById('createPurchase').addEventListener('click', function() {
    if (cart.length === 0) {
        alert('Please add items to the purchase!');
        return;
    }
    
    const vendorId = document.getElementById('VendorSelect').value || null;
    const poBillNo = document.getElementById('poBillNo').value;
    const purchaseDate = document.getElementById('purchaseDate').value;
    let paymentStatus = "";
    const discount = parseFloat(document.getElementById('discountAmount').value) || 0;
    const cgstRate = parseFloat(document.getElementById('cgstRate').value) || 0;
    const sgstRate = parseFloat(document.getElementById('sgstRate').value) || 0;
    const paymentMethod = document.getElementById('paymentMethod').value;
    const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0;
    
    if (!vendorId || !purchaseDate) {
        alert('Please select vendor and purchase date!');
        return;
    }


    // Calculate totals
    let subtotal = 0;
    cart.forEach(item => {
        subtotal += item.price * item.quantity;
    });
    
    const discountedSubtotal = subtotal - discount;
    const totalCGST = (discountedSubtotal * cgstRate) / 100;
    const totalSGST = (discountedSubtotal * sgstRate) / 100;
    const finalTotal = discountedSubtotal + totalCGST + totalSGST;
    

    //SetPayment Status
    if (paymentAmount >= finalTotal) {
        paymentStatus = 'paid';
    } else if (paymentAmount > 0) {
        paymentStatus= 'partial';
    } else {
        paymentStatus = 'unpaid';
    }

    const purchaseData = {
        vendor_id: vendorId,
        po_bill_no: poBillNo,
        purchase_date: purchaseDate,
        payment_status: paymentStatus,
        total_amount: subtotal,
        discount: discount,
        cgst: totalCGST,
        sgst: totalSGST,
        final_amount: finalTotal,
        payment_method: paymentMethod,
        payment_amount: paymentAmount,
        items: cart.map(item => ({
            product_id: item.productId,
            quantity: item.quantity,
            unit_price: item.price,
            total_price: item.price * item.quantity
        }))
    };
    
    // Send to server
    fetch('/purchases/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(purchaseData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Purchase created successfully!');
            window.location.href = '/purchases';
        } else {
            alert('Error creating purchase!');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating purchase!');
    });
});

// vendor search functionality
const vendorSearch = document.getElementById('vendorSearch');
const vendorDropdown = document.getElementById('vendorDropdown');
const selectedVendorDiv = document.getElementById('selectedVendor');
const vendorSelect = document.getElementById('VendorSelect');

vendorSearch.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const vendorOptions = vendorDropdown.querySelectorAll('.vendor-option, [data-vendor-name="Walk-in vendor"]');
    let hasVisibleOptions = false;
    
    vendorOptions.forEach(option => {
        const searchText = option.dataset.searchText || option.dataset.vendorName.toLowerCase();
        if (searchText.includes(searchTerm) || searchTerm === '') {
            option.style.display = 'block';
            hasVisibleOptions = true;
        } else {
            option.style.display = 'none';
        }
    });
    
    if (searchTerm.length > 0 && hasVisibleOptions) {
        vendorDropdown.classList.remove('hidden');
    } else if (searchTerm.length === 0) {
        vendorDropdown.classList.add('hidden');
    }
});

vendorSearch.addEventListener('focus', function() {
    if (this.value.length > 0) {
        vendorDropdown.classList.remove('hidden');
    }
});

vendorSearch.addEventListener('blur', function() {
    // Delay hiding to allow click on dropdown
    setTimeout(() => {
        vendorDropdown.classList.add('hidden');
    }, 300);
});

// vendor selection from dropdown
vendorDropdown.addEventListener('click', function(e) {
    const option = e.target.closest('[data-vendor-id]');
    if (option) {
        selectVendor(
            option.dataset.vendorId,
            option.dataset.vendorName,
            option.dataset.vendorMobile
        );
    }
});

function selectVendor(vendorId, vendorName, vendorMobile) {
    vendorSelect.value = vendorId;
    vendorSearch.value = '';
    vendorDropdown.classList.add('hidden');
    
    if (vendorId) {
        document.getElementById('selectedVendorName').textContent = vendorName;
        document.getElementById('selectedVendorMobile').textContent = vendorMobile;
        selectedVendorDiv.classList.remove('hidden');
        vendorSearch.style.display = 'none';
    } else {
        selectedvendorDiv.classList.add('hidden');
        vendorSearch.style.display = 'block';
        document.getElementById('selectedvendorName').textContent = 'Walk-in vendor';
        document.getElementById('selectedvendorMobile').textContent = '';
    }
}

function clearvendorSelection() {
    vendorSelect.value = '';
    vendorSearch.value = '';
    vendorSearch.style.display = 'block';
    selectedvendorDiv.classList.add('hidden');
    vendorDropdown.classList.add('hidden');
}

// Customer modal functions
document.getElementById('addVendorBtn').addEventListener('click', function() {
    document.getElementById('vendorModal').classList.remove('hidden');
});

function closeVendorModal() {
    document.getElementById('vendorModal').classList.add('hidden');
    document.getElementById('quickVendorForm').reset();
}

function saveVendor() {
    const Vname = document.getElementById('vendorName').value;
    const Vmobile = document.getElementById('vendorMobile').value;

    if (!Vname || !Vmobile) {
        alert('Name and mobile number are required!');
        return;
    }
    const vendorData={
        name:Vname,
        mobile:Vmobile,
    };

    // Send to server
    fetch('/pos/addVendor', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(vendorData)
    })
    .then(response => response.json())
    .then(data => {
        console.log(data.success,"Responed")
        if (data.success) {
            closeVendorModal();
            selectVendor(data.vendorId, Vname, Vmobile);
            alert('Vendor Added successfully!');
        } else {
            alert('Error Creating Customer!');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error Creating Customer!');
    });
}




</script>
{% endblock %} 